<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Crypto Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { background-color: #0d1117; font-family: 'Inter', sans-serif; color: #c9d1d9; }
        .grid-item { 
            background-color: #161b22; 
            border: 1px solid #30363d; 
            border-radius: 6px; 
            padding: 16px; 
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .grid-item:hover {
             background-color: #1f252e;
        }
        .coin-details-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .coin-details-container.expanded {
            max-height: 250px; /* Animate to this height */
        }
        .coin-header h3 { font-size: 1.1rem; font-weight: 600; color: #f0f6fc; }
        .coin-header span { color: #8b949e; font-size: 0.875rem; }
        .price { font-size: 1.75rem; font-weight: 700; color: #f0f6fc; letter-spacing: -0.025em; }
        .change-positive { color: #3fb950; font-weight: 600; }
        .change-negative { color: #f85149; font-weight: 600; }
        .sparkline-chart { width: 100%; height: 50px; }
        .search-input { background-color: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 0.75rem 1rem; border-radius: 6px; width: 100%; }
        .search-input:focus { outline: none; border-color: #3fb950; }
        .load-more-btn { background-color: #238636; color: #f0f6fc; font-weight: 600; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; transition: background-color 0.2s; }
        .load-more-btn:hover { background-color: #2ea043; }
        .load-more-btn:disabled { background-color: #525c67; cursor: not-allowed; }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="mb-8 flex justify-center">
        <input type="text" id="searchInput" placeholder="Search any cryptocurrency..." class="search-input max-w-xl">
    </div>

    <div id="cryptoGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
    </div>

    <div id="statusContainer" class="text-center mt-8">
        <p class="text-gray-500" id="statusMessage">Fetching live cryptocurrency data...</p>
        <button id="loadMoreBtn" class="load-more-btn hidden">Load More</button>
    </div>

    <script>
        const cryptoGrid = document.getElementById('cryptoGrid');
        const searchInput = document.getElementById('searchInput');
        const statusMessage = document.getElementById('statusMessage');
        const loadMoreBtn = document.getElementById('loadMoreBtn');

        let currentPage = 1;
        let allCoinsData = [];
        let debounceTimer;

        async function performSearch(query) {
            cryptoGrid.innerHTML = '';
            statusMessage.textContent = `Searching for "${query}"...`;
            statusMessage.classList.remove('hidden');
            loadMoreBtn.classList.add('hidden');
            try {
                const searchRes = await fetch(`https://api.coingecko.com/api/v3/search?query=${query}`);
                const searchData = await searchRes.json();
                if (!searchData.coins || searchData.coins.length === 0) {
                    statusMessage.textContent = `No results found for "${query}".`;
                    return;
                }
                const coinIds = searchData.coins.slice(0, 50).map(coin => coin.id).join(',');
                const marketsRes = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${coinIds}&sparkline=true&price_change_percentage=24h`);
                const marketsData = await marketsRes.json();
                statusMessage.classList.add('hidden');
                displayCryptoCards(marketsData);
            } catch (error) {
                console.error("Search failed:", error);
                statusMessage.textContent = "Error during search. Please try again.";
            }
        }

        async function loadCryptoData() {
            statusMessage.textContent = "Fetching more coins...";
            statusMessage.classList.remove('hidden');
            loadMoreBtn.disabled = true;
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=${currentPage}&sparkline=true&price_change_percentage=24h`);
                const newCoins = await response.json();
                if (newCoins.length === 0) {
                    statusMessage.textContent = "You've reached the end!";
                    loadMoreBtn.classList.add('hidden');
                    return;
                }
                allCoinsData.push(...newCoins);
                displayCryptoCards(newCoins, true);
                currentPage++;
                statusMessage.classList.add('hidden');
                loadMoreBtn.classList.remove('hidden');
            } catch (error) {
                console.error('Error fetching crypto data:', error);
                statusMessage.textContent = "Failed to load data. Please try again later.";
            } finally {
                loadMoreBtn.disabled = false;
            }
        }

        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                debounceTimer = setTimeout(() => {
                    performSearch(searchTerm);
                }, 500);
            } else {
                statusMessage.classList.add('hidden');
                loadMoreBtn.classList.remove('hidden');
                displayCryptoCards(allCoinsData);
            }
        });

        function displayCryptoCards(coins, shouldAppend = false) {
            if (!shouldAppend) {
                cryptoGrid.innerHTML = '';
            }
            const fragment = document.createDocumentFragment();
            coins.forEach(coin => {
                const priceChange = coin.price_change_percentage_24h || 0;
                const isPositive = priceChange >= 0;
                
                const marketCap = coin.market_cap ? `$${coin.market_cap.toLocaleString('en-US')}` : 'N/A';
                const totalVolume = coin.total_volume ? `$${coin.total_volume.toLocaleString('en-US')}` : 'N/A';
                const fdv = coin.fully_diluted_valuation ? `$${coin.fully_diluted_valuation.toLocaleString('en-US')}` : 'N/A';
                const volToMktCapRatio = (coin.total_volume && coin.market_cap) ? (coin.total_volume / coin.market_cap).toFixed(4) : 'N/A';
                const circulatingSupply = coin.circulating_supply ? coin.circulating_supply.toLocaleString('en-US') : 'N/A';
                const totalSupply = coin.total_supply ? coin.total_supply.toLocaleString('en-US') : 'N/A';
                const maxSupply = coin.max_supply ? coin.max_supply.toLocaleString('en-US') : 'âˆž';

                const card = document.createElement('div');
                card.className = 'grid-item opacity-0';
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <img src="${coin.image}" alt="${coin.name} logo" class="w-8 h-8 mr-3">
                            <div>
                                <h3 class="leading-tight text-base font-bold">${coin.name}</h3>
                                <span class="text-sm text-gray-400">${coin.symbol.toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="price text-lg">$${coin.current_price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 6 })}</p>
                            <span class="inline-block text-base ${isPositive ? 'change-positive' : 'change-negative'}">${isPositive ? '+' : ''}${priceChange.toFixed(2)}%</span>
                        </div>
                    </div>

                    <div class="coin-details-container">
                        <div class="text-xs space-y-1.5 mt-3 pt-3 border-t border-gray-700">
                            <div class="flex justify-between"><span class="text-gray-400">Rank</span> <span class="font-semibold">#${coin.market_cap_rank || 'N/A'}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">Market Cap</span> <span class="font-semibold">${marketCap}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">Volume (24h)</span> <span class="font-semibold">${totalVolume}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">FDV</span> <span class="font-semibold">${fdv}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">Vol/Mkt Cap</span> <span class="font-semibold">${volToMktCapRatio}</span></div>
                            <hr class="border-gray-700 my-2">
                            <div class="flex justify-between"><span class="text-gray-400">Circulating Supply</span> <span class="font-semibold">${circulatingSupply}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">Total Supply</span> <span class="font-semibold">${totalSupply}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">Max. Supply</span> <span class="font-semibold">${maxSupply}</span></div>
                        </div>
                        <canvas class="sparkline-chart mt-4" data-coin-id="${coin.id}"></canvas>
                    </div>
                `;
                fragment.appendChild(card);
            });
            cryptoGrid.appendChild(fragment);

            const newCards = cryptoGrid.querySelectorAll('.opacity-0');
            newCards.forEach(card => {
                const canvas = card.querySelector('canvas');
                const coinId = canvas.dataset.coinId;
                const coinData = coins.find(c => c.id === coinId);
                if (canvas && coinData && coinData.sparkline_in_7d) {
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                    drawSparkline(canvas, coinData.sparkline_in_7d.price, (coinData.price_change_percentage_24h || 0) >= 0);
                }
            });
            gsap.to(newCards, { duration: 0.5, opacity: 1, y: 0, stagger: 0.05, ease: "power2.out" });
        }
        
        function drawSparkline(canvas, prices, isPositive) {
            const ctx = canvas.getContext('2d');
            if (!prices || prices.length < 2) return;
            const minPrice = Math.min(...prices), maxPrice = Math.max(...prices), range = maxPrice - minPrice;
            const scaleX = canvas.width / (prices.length - 1);
            const scaleY = (price) => canvas.height - ((price - minPrice) / range) * canvas.height;
            ctx.beginPath();
            ctx.moveTo(0, scaleY(prices[0]));
            for (let i = 1; i < prices.length; i++) ctx.lineTo(i * scaleX, scaleY(prices[i]));
            ctx.strokeStyle = isPositive ? '#3fb950' : '#f85149';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        loadMoreBtn.addEventListener('click', loadCryptoData);

        // **Event Listener for expanding coin cards**
        cryptoGrid.addEventListener('click', (event) => {
            const card = event.target.closest('.grid-item');
            if (!card) return;

            const detailsContainer = card.querySelector('.coin-details-container');
            if (!detailsContainer) return;
            
            const isAlreadyOpen = detailsContainer.classList.contains('expanded');

            // Close all other expanded cards
            document.querySelectorAll('.grid-item .expanded').forEach(openDetail => {
                openDetail.classList.remove('expanded');
            });

            // If the clicked card was not already open, open it
            if (!isAlreadyOpen) {
                detailsContainer.classList.add('expanded');
            }
        });

        loadCryptoData(); // Initial data load

    </script>
</body>
</html>